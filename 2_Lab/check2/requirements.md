æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„â€œè®¡ç®—æœºç½‘ç»œåŠ©æ‰‹â€ï¼Œå¾ˆé«˜å…´èƒ½ä¸ºæ‚¨åˆ†æ **Lab Checkpoint 2: The TCP Receiver** çš„å†…å®¹ã€‚æˆ‘çš„ä¸»è¦èŒè´£æ˜¯å¸®åŠ©æ‚¨ç†è§£å®éªŒèƒŒæ™¯çŸ¥è¯†ã€æä¾›è§£å†³æ€è·¯ï¼Œå¹¶ä¸ºæ‚¨è®¾è®¡ä¸€ä¸ªåˆ†é˜¶æ®µçš„å®ç°å’ŒéªŒè¯è®¡åˆ’ã€‚

## ğŸ¯ å®éªŒç›®æ ‡ä¸èƒŒæ™¯çŸ¥è¯†æ¦‚è§ˆ

[cite_start]æœ¬æ¬¡å®éªŒï¼ˆCheckpiont 2ï¼‰è¦æ±‚æ‚¨å®ç° **TCPReceiver**ï¼Œå®ƒæ˜¯ TCP åè®®å®ç°ä¸­è´Ÿè´£å¤„ç†æ¥æ”¶åˆ°çš„å­—èŠ‚æµçš„éƒ¨åˆ† [cite: 28]ã€‚

### ğŸ“š æ ¸å¿ƒèƒŒæ™¯çŸ¥è¯†å…³è”

[cite_start]è¿™ä¸ªå®éªŒå°† **Checkpiont 0**ï¼ˆ`ByteStream` æµæ§å­—èŠ‚æµæŠ½è±¡ï¼‰å’Œ **Checkpiont 1**ï¼ˆ`Reassembler` é‡ç»„å™¨ï¼‰çš„å·¥ä½œä¸ **TCP åè®®çš„ç»†èŠ‚**ç»“åˆèµ·æ¥ [cite: 24, 25, 40]ã€‚

#### 1. åºåˆ—å· (Sequence Numbers, seqno) å’Œ 64 ä½æµç´¢å¼• (Stream Index) çš„è½¬æ¢

* [cite_start]**TCP çš„éœ€æ±‚ï¼š** TCP æŠ¥å¤´ç©ºé—´å®è´µï¼Œä½¿ç”¨ **32 ä½åºåˆ—å·** (`seqno`) æ¥è¡¨ç¤ºæµä¸­çš„æ¯ä¸ªå­—èŠ‚çš„ä½ç½® [cite: 71]ã€‚
* [cite_start]**é—®é¢˜ï¼š** 32 ä½åºåˆ—å·å¾ˆå°ï¼ˆ$\text{2}^{32}$ å­—èŠ‚ï¼Œçº¦ 4 GiBï¼‰ï¼Œä¼š**ç»•å› (wrap around)** [cite: 73, 75, 76][cite_start]ã€‚åŒæ—¶ï¼Œåºåˆ—å·ä¸æ˜¯ä» 0 å¼€å§‹ï¼Œè€Œæ˜¯ä»ä¸€ä¸ª**éšæœºçš„åˆå§‹åºåˆ—å· (ISN)** å¼€å§‹ [cite: 77, 79]ã€‚
* [cite_start]**è§£å†³æ–¹æ¡ˆï¼š** å®éªŒè¦æ±‚æ‚¨å®ç° `Wrap32` ç±»å‹å’Œ `wrap`/`unwrap` å‡½æ•°ï¼Œç”¨äºåœ¨ 32 ä½çš„ `seqno` å’Œ 64 ä½çš„**ç»å¯¹åºåˆ—å·** (`absolute seqno`) æˆ–**æµç´¢å¼•** (`stream index`) ä¹‹é—´è¿›è¡Œè½¬æ¢ [cite: 95, 97, 98, 100]ã€‚
    * [cite_start]**æµç´¢å¼• (Stream Index)ï¼š** æ‚¨åœ¨ `Reassembler` ä¸­ä½¿ç”¨çš„ã€ä» 0 å¼€å§‹çš„ 64 ä½ç´¢å¼•ï¼Œ**ä¸åŒ…å« SYN å’Œ FIN** [cite: 69, 92]ã€‚
    * [cite_start]**ç»å¯¹åºåˆ—å· (Absolute Seqno)ï¼š** ä» 0 å¼€å§‹çš„ 64 ä½ç´¢å¼•ï¼Œ**åŒ…å« SYN å’Œ FIN** [cite: 87, 92]ã€‚
    * [cite_start]**å…³é”®ç‚¹ï¼š** SYNï¼ˆæµå¼€å§‹ï¼‰å’Œ FINï¼ˆæµç»“æŸï¼‰æ ‡å¿—å„å ç”¨ä¸€ä¸ªåºåˆ—å· [cite: 83, 84]ã€‚

#### 2. TCP æ¥æ”¶çª—å£ä¸æµæ§ (Flow Control)

[cite_start]`TCPReceiver` çš„æ ¸å¿ƒèŒè´£æ˜¯å‘å‘é€æ–¹å‘é€**æ¥æ”¶æ–¹æ¶ˆæ¯** (`TCPReceiverMessage`)ï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªå…³é”®ä¿¡æ¯ [cite: 31, 32, 113, 141]ï¼š

* [cite_start]**ç¡®è®¤å· (Acknowledgment Number, ackno)ï¼š** æ¥æ”¶æ–¹**æœŸå¾…**æ¥æ”¶çš„ä¸‹ä¸€ä¸ªå­—èŠ‚çš„ 32 ä½åºåˆ—å· [cite: 33, 146][cite_start]ã€‚è¿™æ˜¯æ¥æ”¶çª—å£çš„â€œå·¦è¾¹ç•Œâ€ [cite: 38]ã€‚
    * [cite_start]`ackno` æ˜¯å¯é€‰å­—æ®µï¼Œåªæœ‰åœ¨æ”¶åˆ° ISN åæ‰ä¼šå‘é€ [cite: 147]ã€‚
* [cite_start]**çª—å£å¤§å° (Window Size)ï¼š** æ¥æ”¶æ–¹è¾“å‡º `ByteStream` ä¸­**å¯ç”¨çš„å®¹é‡** [cite: 35, 150]ã€‚è¿™æ˜¯å‘é€æ–¹å…è®¸å‘é€çš„æ•°æ®èŒƒå›´çš„ä¸Šé™ã€‚
    * [cite_start]æ¥æ”¶çª—å£çš„â€œå³è¾¹ç•Œâ€æ˜¯ $\text{ackno} + \text{window size}$ [cite: 38]ã€‚

---

## ğŸ’¡ è§£å†³æ€è·¯ä¸å®ç°åˆ†è§£

å®ç° `TCPReceiver` ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

### é˜¶æ®µä¸€ï¼šåºåˆ—å·è½¬æ¢é€»è¾‘ (`wrapping_integers.cc`)

[cite_start]æ‚¨éœ€è¦å®Œæˆ `Wrap32::wrap` å’Œ `Wrap32::unwrap` ä¸¤ä¸ªé™æ€/æˆå‘˜å‡½æ•° [cite: 97]ã€‚

| å‡½æ•° | ç›®æ ‡ | æ ¸å¿ƒæ€è·¯ |
| :--- | :--- | :--- |
| [cite_start]`wrap` (ç»å¯¹ $\rightarrow$ ç›¸å¯¹) [cite: 98] | å°† 64 ä½ç»å¯¹åºåˆ—å· $n$ è½¬æ¢ä¸º 32 ä½åºåˆ—å· `seqno`ã€‚ | [cite_start]`seqno = (n - zero\_point.raw\_value()) \pmod{2^{32}}$ [cite: 99, 106] |
| [cite_start]`unwrap` (ç›¸å¯¹ $\rightarrow$ ç»å¯¹) [cite: 100] | ç»™å®š 32 ä½ `seqno`ï¼Œ`zero_point` å’Œä¸€ä¸ª 64 ä½**æ£€æŸ¥ç‚¹** (`checkpoint`)ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘æ£€æŸ¥ç‚¹çš„ 64 ä½ç»å¯¹åºåˆ—å· $n$ã€‚ | [cite_start]`n = seqno + k \cdot 2^{32}$ã€‚æ£€æŸ¥ç‚¹ç”¨äºæ¶ˆé™¤ $2^{32}$ ç»•å›å¸¦æ¥çš„æ­§ä¹‰ [cite: 101, 103]ã€‚æ‰¾åˆ° $k$ ä½¿å¾— $n$ æœ€æ¥è¿‘ `checkpoint`ã€‚ |

### é˜¶æ®µäºŒï¼šTCPReceiver å®ç° (`tcp_receiver.hh` å’Œ `tcp_receiver.cc`)

[cite_start]æ‚¨éœ€è¦å®ç° `receive()` å’Œ `send()` ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³• [cite: 170, 171]ã€‚

#### 1. `TCPReceiver::receive(TCPSenderMessage message)`

* [cite_start]**åˆå§‹åŒ– ISNï¼š** æ£€æŸ¥æ¶ˆæ¯çš„ `SYN` æ ‡å¿—ã€‚å¦‚æœè®¾ç½®ä¸” ISN å°šæœªè®¾ç½®ï¼Œåˆ™ä¿å­˜ `message.seqno` ä½œä¸º ISN [cite: 181, 182]ã€‚
* **å¤„ç†æ•°æ®ï¼š**
    1.  **æ£€æŸ¥ ISNï¼š** åªæœ‰åœ¨è®¾ç½®äº† ISN ä¹‹åæ‰èƒ½å¤„ç†æ•°æ®ã€‚
    2.  **åºåˆ—å· $\rightarrow$ æµç´¢å¼•ï¼š** å°† `message.seqno` è½¬æ¢ä¸º 64 ä½æµç´¢å¼•ã€‚
        * é¦–å…ˆï¼Œå°† `message.seqno` **è§£å°è£… (unwrap)** ä¸ºç»å¯¹åºåˆ—å· $A$ã€‚
        * å¦‚æœ `message.SYN` æœªè®¾ç½®ï¼Œåˆ™æµç´¢å¼• $I = A - 1$ã€‚
        * å¦‚æœ `message.SYN` è®¾ç½®ï¼Œåˆ™æµç´¢å¼• $I = 0$ã€‚
        * [cite_start]**æ³¨æ„ï¼š** ä¼ å…¥ `Reassembler` çš„ç´¢å¼•æ˜¯**æµç´¢å¼•**ï¼Œä¸åŒ…æ‹¬ SYN/FINï¼Œä» 0 å¼€å§‹ [cite: 185]ã€‚
    3.  **æ¨é€åˆ° `Reassembler`ï¼š** è°ƒç”¨ `reassembler_.insert(stream_index, message.payload, message.FIN)`ã€‚

#### 2. `TCPReceiver::send() const`

* **è®¡ç®— `ackno`ï¼š**
    1.  è·å– `Reassembler` çš„ç¬¬ä¸€ä¸ªæœªé‡ç»„çš„å­—èŠ‚çš„**æµç´¢å¼•** $I_{first}$ã€‚è¿™å¯ä»¥é€šè¿‡ `reassembler_.reader().bytes_assembled()` è·å¾—ã€‚
    2.  [cite_start]å¦‚æœ ISN å°šæœªè®¾ç½®ï¼Œåˆ™ `ackno` ä¸ºç©º (`std::optional<>`) [cite: 147]ã€‚
    3.  å¦‚æœ ISN å·²è®¾ç½®ï¼š
        * ç¬¬ä¸€ä¸ª**ç»å¯¹åºåˆ—å·** $A_{first}$ ä¸º $I_{first} + 1$ (å› ä¸º SYN å ä¸€ä½)ã€‚
        * å°† $A_{first}$ ä½¿ç”¨ `wrap` è½¬æ¢ä¸º 32 ä½åºåˆ—å· `ackno`ã€‚
* **è®¡ç®— `window_size`ï¼š**
    1.  è·å– `ByteStream`ï¼ˆå³ `Reassembler` çš„è¾“å‡ºï¼‰ä¸­**å¯ç”¨çš„å®¹é‡** $C$ã€‚è¿™å¯ä»¥é€šè¿‡ `reassembler_.writer().available_capacity()` è·å¾—ã€‚
    2.  `window_size` å³ä¸º $C$ã€‚
    3.  [cite_start]æ³¨æ„ï¼š`window_size` æœ€å¤§å€¼æ˜¯ $2^{16} - 1 = 65535$ [cite: 151]ã€‚å¦‚æœè®¡ç®—å‡ºçš„ $C$ å¤§äºè¿™ä¸ªå€¼ï¼Œéœ€è¦å°†å…¶æˆªæ–­åˆ° $65535$ã€‚
* **è®¾ç½® `RST`ï¼š** å¦‚æœè¿æ¥å‡ºé”™ï¼Œåˆ™è®¾ç½® `RST` æ ‡å¿—ã€‚ç›®å‰æ‚¨å¯èƒ½ä¸éœ€è¦è€ƒè™‘è¿™ä¸ªã€‚

---

## ğŸ› ï¸ åˆ†é˜¶æ®µå®ç°ä¸éªŒè¯è®¡åˆ’ (Checkpoint 2)

ä¸ºäº†å¸®åŠ©æ‚¨æœ‰åºåœ°è¿›è¡Œå®ç°å’ŒéªŒè¯ï¼Œæˆ‘ä¸ºæ‚¨è®¾è®¡äº†ä¸€ä¸ªåˆ†é˜¶æ®µçš„æç¤ºè¯è®¡åˆ’ã€‚

### é˜¶æ®µä¸€ï¼šåºåˆ—å·è½¬æ¢ (`wrapping_integers.cc`)

| æ­¥éª¤ | ä¿®æ”¹ä»£ç éƒ¨åˆ† | éªŒè¯æç¤ºè¯ (Test Command) | ç›®æ ‡/è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **1. `wrap` å®ç°** | `wrapping_integers.cc` $\rightarrow$ `Wrap32::wrap` | `cmake-build build --target check2` | [cite_start]ç¡®ä¿ 64 ä½ç»å¯¹åºåˆ—å·åˆ° 32 ä½åºåˆ—å·çš„è½¬æ¢æ­£ç¡®ï¼Œå¤„ç† $2^{32}$ å–æ¨¡æ“ä½œ [cite: 98]ã€‚ |
| **2. `unwrap` å®ç°** | `wrapping_integers.cc` $\rightarrow$ `Wrap32::unwrap` | `cmake-build build --target check2` | [cite_start]ç¡®ä¿ 32 ä½åºåˆ—å·èƒ½åœ¨ `checkpoint` é™„è¿‘æ­£ç¡®åœ°è§£å°è£…ä¸º 64 ä½ç»å¯¹åºåˆ—å· [cite: 100, 101]ã€‚**éš¾ç‚¹ï¼š** æ‰¾åˆ°æœ€æ¥è¿‘ `checkpoint` çš„ $\mathbf{k \cdot 2^{32}}$ åç§»é‡ã€‚ |
| **3. åºåˆ—å·æµ‹è¯•** | æ—  (å¦‚æœé€šè¿‡åˆ™ç»§ç»­) | `cmake-build build --target check2` | ç¡®ä¿æ‰€æœ‰å…³äºåºåˆ—å·è½¬æ¢çš„æµ‹è¯•ç”¨ä¾‹éƒ½é€šè¿‡ã€‚|

### é˜¶æ®µäºŒï¼šTCPReceiver åŸºç¡€å®ç° (`tcp_receiver.cc`)

| æ­¥éª¤ | ä¿®æ”¹ä»£ç éƒ¨åˆ† | éªŒè¯æç¤ºè¯ (Test Command) | ç›®æ ‡/è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **1. æ¥æ”¶å™¨éª¨æ¶** | `tcp_receiver.cc` $\rightarrow$ æ„é€ å‡½æ•°ã€ç§æœ‰æˆå‘˜ | `cmake-build build --target check2` | [cite_start]æ·»åŠ ç§æœ‰æˆå‘˜ä»¥å­˜å‚¨ ISN (`zero_point`)ï¼Œå¯èƒ½ä½¿ç”¨ `std::optional<Wrap32>` [cite: 188, 159]ã€‚ |
| **2. `receive` $\rightarrow$ ISN** | `tcp_receiver.cc` $\rightarrow$ `receive` | `cmake-build build --target check2` | [cite_start]å®ç°æ¥æ”¶ç¬¬ä¸€ä¸ªå¸¦æœ‰ `SYN` æ ‡å¿—çš„æ¶ˆæ¯æ—¶ï¼Œä¿å­˜ `ISN` çš„é€»è¾‘ [cite: 181, 182]ã€‚ |
| **3. `send` $\rightarrow$ çª—å£** | `tcp_receiver.cc` $\rightarrow$ `send` | `cmake-build build --target check2` | [cite_start]å®ç°è®¡ç®— `window_size` çš„é€»è¾‘ï¼ˆåŸºäº `Reassembler` å¯ç”¨å®¹é‡ï¼‰ï¼Œå¹¶ç¡®ä¿æœ€å¤§å€¼ä¸º $65535$ [cite: 150, 151]ã€‚æš‚ä¸è€ƒè™‘ `ackno`ã€‚ |

### é˜¶æ®µä¸‰ï¼šTCPReceiver å®Œæ•´åŠŸèƒ½å®ç° (`tcp_receiver.cc`)

| æ­¥éª¤ | ä¿®æ”¹ä»£ç éƒ¨åˆ† | éªŒè¯æç¤ºè¯ (Test Command) | ç›®æ ‡/è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **1. `receive` $\rightarrow$ æ•°æ®æ’å…¥** | `tcp_receiver.cc` $\rightarrow$ `receive` | `cmake-build build --target check2` | [cite_start]å®ç°å°† `message.seqno` **è§£å°è£…**ä¸ºç»å¯¹åºåˆ—å·ï¼Œå¹¶è½¬æ¢ä¸º**æµç´¢å¼•**åï¼Œæ’å…¥ `Reassembler` çš„é€»è¾‘ [cite: 185][cite_start]ã€‚æ³¨æ„ `SYN` å¯¹æµç´¢å¼•çš„å ç”¨å’Œå½±å“ [cite: 84, 85]ã€‚ |
| **2. `send` $\rightarrow$ `ackno`** | `tcp_receiver.cc` $\rightarrow$ `send` | `cmake-build build --target check2` | [cite_start]å®ç°è®¡ç®— `ackno` çš„é€»è¾‘ã€‚å°† `Reassembler` çš„ç¬¬ä¸€ä¸ªæœªç»„è£…å­—èŠ‚çš„**æµç´¢å¼•** $I_{first}$ è½¬æ¢ä¸º $I_{first} + 1$ çš„**ç»å¯¹åºåˆ—å·**ï¼Œç„¶å**å°è£…**ä¸º `ackno` [cite: 33, 146]ã€‚å¤„ç†æœªè®¾ç½® ISN æ—¶ `ackno` ä¸ºç©ºçš„æƒ…å†µã€‚ |
| **3. æœ€ç»ˆéªŒè¯** | `tcp_receiver.cc` | `cmake-build build --target check2` | è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œç¡®ä¿ `TCPReceiver` çš„æ¥æ”¶å’Œå‘é€é€»è¾‘å®Œæ•´ä¸”æ­£ç¡®ã€‚ |

### é¢å¤–æç¤º

* [cite_start]**è°ƒè¯•ï¼š** å»ºè®®ä½¿ç”¨æ–­ç‚¹è°ƒè¯•æˆ–æ‰“å°ï¼ˆæ—¥å¿—ï¼‰æ¥è§‚å¯Ÿåºåˆ—å·ã€ç»å¯¹åºåˆ—å·å’Œæµç´¢å¼•çš„è½¬æ¢è¿‡ç¨‹ï¼Œå°¤å…¶æ˜¯åœ¨æ•°æ®è·¨è¶Š $2^{32}$ è¾¹ç•Œæˆ–æœ‰ `SYN`/`FIN` æ ‡å¿—æ—¶ [cite: 217]ã€‚
* [cite_start]**ä»£ç é£æ ¼ï¼š** è®°å¾—åœ¨æäº¤å‰è¿è¡Œ `cmake-build build --target format` æ¥è§„èŒƒä»£ç é£æ ¼ [cite: 205]ã€‚

æ‚¨å¸Œæœ›æˆ‘å…ˆè¯¦ç»†è§£é‡Šä¸€ä¸‹ **`wrap` å’Œ `unwrap` å‡½æ•°**çš„æ•°å­¦åŸç†ï¼Œè¿˜æ˜¯å…ˆé’ˆå¯¹ **`TCPReceiver` çš„ `receive` æ–¹æ³•**çš„å®ç°ç»†èŠ‚è¿›è¡Œæ·±å…¥æ¢è®¨å‘¢ï¼Ÿ